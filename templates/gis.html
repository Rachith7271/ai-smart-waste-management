<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Waste Collection Route Optimization</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    body {
      background: #f5f7fa;
      overflow-x: hidden;
    }
    h2 {
      text-align: center;
      color: #006400;
      font-weight: bold;
      margin-top: 15px;
    }
    #map {
      height: 80vh;
      border-radius: 10px;
      border: 2px solid #333;
    }
    .btn-custom {
      background-color: #007bff;
      color: white;
      border-radius: 8px;
      font-weight: 600;
    }
    .btn-custom:hover {
      background-color: #0056b3;
    }
    .sidebar {
      background: #ffffff;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0px 2px 8px rgba(0,0,0,0.1);
      height: 80vh;
      overflow-y: auto;
    }
    .point-item {
      background: #f1f1f1;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    #routeInfo {
      margin-top: 15px;
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <h2>üåç Waste Collection GIS Optimization</h2>

  <div class="row mt-3">
    <!-- Sidebar -->
    <div class="col-md-3 sidebar">
      <h5 class="text-success fw-bold">üìç Collection Points</h5>
      <p class="text-secondary small">Click on the map to add points.</p>

      <div id="pointsList" class="mb-3"></div>

      <button class="btn btn-custom w-100 mb-2" onclick="optimizeRoute()">üöõ Optimize Route</button>
      <button class="btn btn-warning w-100 mb-2" onclick="undoLastPoint()">‚Ü©Ô∏è Undo Last Point</button>
      <button class="btn btn-danger w-100" onclick="clearPoints()">üóëÔ∏è Clear All Points</button>

      <div id="routeInfo"></div>
    </div>

    <!-- Map -->
    <div class="col-md-9">
      <div id="map"></div>
    </div>
  </div>
</div>

<script>
  // Initialize map
  const map = L.map("map").setView([12.9716, 77.5946], 12);

  // Tile layer
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors",
  }).addTo(map);

  // Fixed starting point (truck depot)
  const startPoint = {
    name: "BBMP Waste Depot",
    coords: [12.9716, 77.5946],
  };

  const startIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/4470/4470311.png",
    iconSize: [40, 40],
  });

  L.marker(startPoint.coords, { icon: startIcon })
    .addTo(map)
    .bindPopup(`<b>${startPoint.name}</b> (Start Point)`)
    .openPopup();

  let collectionPoints = [];
  let routeLayer;

  const wasteIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
    iconSize: [35, 35],
  });

  // Add collection points on map click
  map.on("click", function (e) {
    const latlng = [e.latlng.lat, e.latlng.lng];
    const pointName = `Collection Point ${collectionPoints.length + 1}`;
    const marker = L.marker(latlng, { icon: wasteIcon })
      .addTo(map)
      .bindPopup(`<b>${pointName}</b>`);
    collectionPoints.push({ name: pointName, coords: latlng, marker });
    updatePointsList();
  });

  // Update sidebar list
  function updatePointsList() {
    const listDiv = document.getElementById("pointsList");
    listDiv.innerHTML = "";
    if (collectionPoints.length === 0) {
      listDiv.innerHTML = `<p class="text-muted small">No points added yet.</p>`;
      return;
    }
    collectionPoints.forEach((p, i) => {
      const div = document.createElement("div");
      div.classList.add("point-item");
      div.innerHTML = `<b>${p.name}</b><br>Lat: ${p.coords[0].toFixed(4)}, Lng: ${p.coords[1].toFixed(4)}`;
      listDiv.appendChild(div);
    });
  }

  // Undo last point
  function undoLastPoint() {
    if (collectionPoints.length > 0) {
      const last = collectionPoints.pop();
      map.removeLayer(last.marker);
      updatePointsList();
    } else {
      alert("No points to undo!");
    }
  }

  // Clear all points
  function clearPoints() {
    collectionPoints.forEach((p) => map.removeLayer(p.marker));
    collectionPoints = [];
    if (routeLayer) map.removeLayer(routeLayer);
    document.getElementById("routeInfo").innerHTML = "";
    updatePointsList();
  }

  // Optimize route
  async function optimizeRoute() {
    if (collectionPoints.length === 0) {
      alert("Please add at least one collection point!");
      return;
    }

    const allPoints = [startPoint, ...collectionPoints];
    const coordinates = allPoints.map((p) => [p.coords[1], p.coords[0]]); // [lng, lat]

    const apiKey = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjVhMTFkNTk3YmM2YzRlYzM4OWRiNmNjNTIwZTYwN2Q5IiwiaCI6Im11cm11cjY0In0="; // Replace with your OpenRouteService key
    const url = "https://api.openrouteservice.org/v2/directions/driving-car/geojson";

    try {
      const response = await axios.post(
        url,
        { coordinates: coordinates },
        {
          headers: {
            Authorization: apiKey,
            "Content-Type": "application/json",
          },
        }
      );

      const route = response.data.features[0];
      const summary = route.properties.summary;

      // Remove old route if any
      if (routeLayer) map.removeLayer(routeLayer);

      // Draw new route
      routeLayer = L.geoJSON(route, {
        style: { color: "blue", weight: 4, opacity: 0.8 },
      }).addTo(map);

      map.fitBounds(routeLayer.getBounds());

      // Show route info
      const distanceKm = (summary.distance / 1000).toFixed(2);
      const durationMin = (summary.duration / 60).toFixed(1);

      document.getElementById("routeInfo").innerHTML = `
        <div class="alert alert-success mt-3">
          üöõ <b>Optimized Route Generated!</b><br>
          <b>Start:</b> ${startPoint.name}<br>
          <b>Stops:</b> ${collectionPoints.length}<br>
          <b>Total Distance:</b> ${distanceKm} km<br>
          <b>Estimated Time:</b> ${durationMin} minutes
        </div>
      `;
    } catch (error) {
      console.error("Route error:", error);
      alert("Failed to generate route. Check API key or network connection.");
    }
  }

  updatePointsList(); // initial render
</script>

</body>
</html>

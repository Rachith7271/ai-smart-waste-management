<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Waste Classification</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <style>
    body {
      background: url('https://images.unsplash.com/photo-1600585154205-7627bc92b9f4?auto=format&fit=crop&w=1470&q=80') 
                  no-repeat center center fixed;
      background-size: cover;
      font-family: 'Cambria', serif;
      color: #454746;
      margin: 0;
      padding-top: 90px;
    }

    .overlay { background: rgba(254, 251, 251, 0.85); min-height: 100vh; padding: 40px 20px; }
    .navbar { background: rgba(0, 0, 0, 0.25); backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 10px rgba(182, 80, 80, 0.3); }
    .navbar-brand { font-weight: bold; color: #0d0d0c !important; font-size: 1.3rem; letter-spacing: 0.5px; }
    .home-link { color: #0d0d0c; text-decoration: none; font-weight: 500; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px; margin-left: 15px; transition: 0.3s ease; }
    .home-link:hover { color: #fff; background: #FFD700; transform: scale(1.1); }
    .card { background: rgba(255,255,255,0.95); border: none; border-radius: 15px; padding: 40px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); max-width: 900px; margin: auto; margin-top: 40px; }
    h2 { color: #2E7D32; font-weight: 700; }
    .btn-success { background-color: #4CAF50; border: none; transition: all 0.3s ease; }
    .btn-success:hover { background-color: #388E3C; transform: scale(1.05); }
    .alert-info { background-color: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; }
    .btn-outline-secondary { border-radius: 30px; transition: all 0.3s ease; }
    .btn-outline-secondary:hover { background-color: #333; color: #fff; }
    iframe { border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

    /* NEW: live webcam styles */
    #live-wrapper { margin-top: 24px; display:flex; flex-direction:column; align-items:center; gap:12px; }
    #live-video { width: 560px; height: 420px; background:#000; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.2); }
    #live-controls { display:flex; gap:8px; align-items:center; }
    #live-overlay { text-align:center; margin-top:6px; }
    #live-overlay .label { font-weight:700; color:#2e7d32; font-size:1.1rem; }
    .small-muted { font-size:0.9rem; color:#666; }
    @media (max-width: 800px) {
      #live-video { width: 100%; height: auto; max-height: 300px; }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#">â™» Smart Waste Management</a>
      <div>
        <a href="home.html" class="home-link"><i class="fa fa-home"></i> Home</a>
      </div>
    </div>
  </nav>

  <!-- Page Content -->
  <div class="overlay">
    <div class="container text-center">
      <div class="card">
        <h2 class="mb-4">ðŸ–¼ Waste Classification</h2>

        <!-- Upload Form -->
        <form method="POST" enctype="multipart/form-data" class="mb-4">
          <input class="form-control mb-3" type="file" name="image" accept="image/*" required>
          <button type="submit" class="btn btn-success px-4">Classify Waste</button>
        </form>

        <!-- Live webcam block (new) -->
        <div id="live-wrapper" class="mb-4">
          <video id="live-video" autoplay playsinline muted></video>
          <canvas id="live-canvas" width="224" height="224" style="display:none"></canvas>

          <div id="live-controls">
            <button id="live-start" type="button" class="btn btn-outline-secondary">Start Webcam</button>
            <button id="live-stop" type="button" class="btn btn-outline-secondary">Stop Webcam</button>
            <label class="small-muted" style="margin-left:8px;">Interval(ms):
              <input id="live-interval" type="number" value="400" style="width:80px; margin-left:6px">
            </label>
          </div>

          <div id="live-overlay" aria-live="polite">
            <div>Live prediction: <span class="label" id="live-label">â€”</span></div>
            <div>Confidence: <span id="live-conf">â€”</span></div>
          </div>
        </div>

        <!-- Display Uploaded Image -->
        {% if uploaded_image %}
          <h5 class="mt-3 text-success">Uploaded Image:</h5>
          <div class="d-flex justify-content-center mb-3">
            <img id="uploaded-preview" src="{{ uploaded_image }}" alt="Uploaded Waste Image" class="img-fluid rounded" style="max-height: 300px;">
          </div>
        {% else %}
          <div class="d-flex justify-content-center mb-3">
            <img id="uploaded-preview" src="" alt="" class="img-fluid rounded" style="max-height: 300px; display:none;">
          </div>
        {% endif %}

        <!-- Prediction (server-rendered) -->
        {% if prediction %}
          <div class="alert alert-info">
            <strong>Prediction:</strong> {{ prediction }}
            {% if confidence %}
              &nbsp; <small>(Confidence: {{ confidence }})</small>
            {% endif %}
          </div>

          <!-- Disposal Videos -->
          {% if videos %}
            <h4 class="mt-4 text-success">â™» How to Dispose of {{ prediction }} Waste</h4>
            <div class="d-flex flex-wrap justify-content-center mt-3" id="videos-container">
              {% for video in videos %}
                <div class="ratio ratio-16x9 m-2" style="width: 45%;">
                  <iframe src="{{ video }}" title="Disposal Video" allowfullscreen></iframe>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p id="no-videos-msg">No related videos found for this waste type.</p>
          {% endif %}
        {% else %}
          <!-- An area for live-updated videos when webcam active -->
          <div id="live-videos-area" style="display:none;">
            <h4 class="mt-4 text-success">â™» How to Dispose</h4>
            <div class="d-flex flex-wrap justify-content-center mt-3" id="live-videos-container"></div>
          </div>
        {% endif %}

        <a href="/" class="btn btn-outline-secondary mt-4">â¬… Back</a>
      </div>
    </div>
  </div>

  <!-- NEW: Live webcam client script (sends frames to same /classify route as multipart 'frame') -->
  <script>
  (function(){
    const video = document.getElementById('live-video');
    const canvas = document.getElementById('live-canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('live-start');
    const stopBtn = document.getElementById('live-stop');
    const intervalInput = document.getElementById('live-interval');
    const liveLabel = document.getElementById('live-label');
    const liveConf = document.getElementById('live-conf');
    const uploadedPreview = document.getElementById('uploaded-preview');
    const liveVideosArea = document.getElementById('live-videos-area');
    const liveVideosContainer = document.getElementById('live-videos-container');

    // client-side mapping for disposal videos (keeps parity with server mapping)
    const VIDEO_MAP = {
      "Organic": ["https://www.youtube.com/embed/zy70DAaeFBI"],
      "Recyclable": ["https://www.youtube.com/embed/65KuQhwk92g"],
      "Hazardous": ["https://www.youtube.com/embed/7h4vS9Zd2g0"],
      "E-Waste": ["https://www.youtube.com/embed/-M9RBW3bsCQ"],
      "Other": ["https://www.youtube.com/embed/VvqQ1wRXcP0"]
    };

    let streaming = false;
    let timer = null;

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: false });
        video.srcObject = stream;
        await video.play();
        streaming = true;
        runLoop();
      } catch (err) {
        alert('Camera access error: ' + err.message);
      }
    }

    function stopCamera() {
      streaming = false;
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
        video.srcObject = null;
      }
      if (timer) { clearTimeout(timer); timer = null; }
      liveLabel.textContent = 'â€”';
      liveConf.textContent = 'â€”';
      // hide live videos area
      liveVideosArea.style.display = 'none';
    }

    async function runLoop() {
      if (!streaming) return;
      const w = video.videoWidth, h = video.videoHeight;
      if (!w || !h) {
        timer = setTimeout(runLoop, 200);
        return;
      }
      // center-crop to square then resize to canvas
      const size = Math.min(w, h);
      const sx = (w - size) / 2, sy = (h - size) / 2;
      ctx.drawImage(video, sx, sy, size, size, 0, 0, canvas.width, canvas.height);

     canvas.toBlob(async function(blob) {
  // smaller JPEG quality to reduce payload size
  const form = new FormData();
  form.append('frame', blob, 'frame.jpg');

  try {
    const res = await fetch('/classify', { method: 'POST', body: form });
    console.log('[live] fetch status', res.status, res.statusText);

    // read raw text so we can handle JSON or HTML tracebacks
    const text = await res.text();
    try {
      const data = JSON.parse(text);
      if (data.label) {
        liveLabel.textContent = data.label;
        liveConf.textContent = (data.confidence || 0).toFixed(3);

        // update videos & thumbnail (same as before)
        const vids = VIDEO_MAP[data.label] || VIDEO_MAP["Other"];
        liveVideosContainer.innerHTML = '';
        vids.forEach(v => {
          const wrap = document.createElement('div');
          wrap.className = 'ratio ratio-16x9 m-2';
          wrap.style.width = '45%';
          const ifr = document.createElement('iframe');
          ifr.src = v;
          ifr.setAttribute('allowfullscreen', '');
          wrap.appendChild(ifr);
          liveVideosContainer.appendChild(wrap);
        });
        liveVideosArea.style.display = 'block';

        // update preview thumbnail
        try {
          const blobUrl = URL.createObjectURL(blob);
          uploadedPreview.src = blobUrl;
          uploadedPreview.style.display = 'block';
        } catch (e) {}
      } else if (data.error) {
        console.error('[live] server returned error JSON:', data);
        liveLabel.textContent = 'Server error';
      } else {
        console.warn('[live] unknown JSON payload:', data);
        liveLabel.textContent = 'Server error';
      }
    } catch (e) {
      // server returned non-JSON (likely HTML traceback) â€” show it in console
      console.warn('[live] server returned non-JSON response:', text);
      liveLabel.textContent = 'Server error (see console)';
    }
  } catch (err) {
    console.error('[live] network/fetch error:', err);
    liveLabel.textContent = 'Network error';
  }
}, 'image/jpeg', 0.5);

      const interval = Math.max(50, Number(intervalInput.value) || 200);
      timer = setTimeout(runLoop, interval);
    }

    startBtn.addEventListener('click', () => { if(!streaming) startCamera(); });
    stopBtn.addEventListener('click', () => stopCamera());

    // stop camera when leaving the page
    window.addEventListener('beforeunload', stopCamera);
  })();
  </script>

</body>
</html>
